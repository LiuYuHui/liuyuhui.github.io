<!DOCTYPE html>
<html lang="default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"liuyuhui.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="This blog summarizes what I have done before GSoC’s first evaluation.">
<meta property="og:type" content="article">
<meta property="og:title" content="GSoC First Evaluations">
<meta property="og:url" content="http://liuyuhui.github.io/2020/06/25/GSoC-First-Evaluations/index.html">
<meta property="og:site_name" content="progress">
<meta property="og:description" content="This blog summarizes what I have done before GSoC’s first evaluation.">
<meta property="article:published_time" content="2020-06-25T11:24:11.000Z">
<meta property="article:modified_time" content="2020-07-27T02:30:40.267Z">
<meta property="article:author" content="liuyuhui">
<meta property="article:tag" content="GSoC">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://liuyuhui.github.io/2020/06/25/GSoC-First-Evaluations/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'default'
  };
</script>

  <title>GSoC First Evaluations | progress</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">progress</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">I'd rather be anything but ordinary</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="http://liuyuhui.github.io/2020/06/25/GSoC-First-Evaluations/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liuyuhui">
      <meta itemprop="description" content="This is my blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="progress">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          GSoC First Evaluations
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-25 19:24:11" itemprop="dateCreated datePublished" datetime="2020-06-25T19:24:11+08:00">2020-06-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-27 10:30:40" itemprop="dateModified" datetime="2020-07-27T10:30:40+08:00">2020-07-27</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>This blog summarizes what I have done before GSoC’s first evaluation.  <a id="more"></a>I will talk about three cool things: </p>
<ul>
<li>refactoring all Machine classes to not have labels/features as part of their state</li>
<li>finding all classes needed to be refactored with <a href="https://clang.llvm.org/docs/LibTooling.html" target="_blank" rel="noopener">LibTooling</a></li>
<li>writing a <code>LabelEncoder</code> to allow users to pass arbitrary discrete values as classification labels.</li>
</ul>
<h2 id="Refactoring-all-Machine-class"><a href="#Refactoring-all-Machine-class" class="headerlink" title="Refactoring all Machine class"></a>Refactoring all Machine class</h2><p>Currently, there are two most important member functions in the shogun <code>Machine</code> class: <code>train</code> and <code>apply</code>, the current usage is:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">shared_ptr</span>&lt;Features&gt; train_data;</span><br><span class="line"><span class="built_in">shared_ptr</span>&lt;Labels&gt; train_labels;</span><br><span class="line"><span class="keyword">auto</span> reg = create&lt;Machine&gt;(<span class="string">"LeastSquaresRegression"</span>);</span><br><span class="line">reg-&gt;set_labels(train_labels);</span><br><span class="line">reg-&gt;set_features(train_data);</span><br><span class="line">reg-&gt;train();</span><br></pre></td></tr></table></figure>
<p>The <code>Machine</code> class stores features and labels, i.e. it is stateful, and causes confusion about which features and labels are used for training.<br><code>Features</code> and <code>Labels</code> should not be stored in the object, we should use the features and labels which are passed to <code>train</code> and <code>apply</code>. So I started by refactoring this class to make it stateless.<br>The new API looks like this</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> test_labels = create&lt;Machine&gt;(<span class="string">"LeastSquaresRegression"</span>)</span><br><span class="line">                        -&gt;fit(train_features, train_labels)</span><br><span class="line">                        -&gt;predict(test_data);</span><br></pre></td></tr></table></figure>
<p>We want to refactor the <code>Machine</code> base class to be stateless, but not all algorithms can be stateless. Non-parametric machines (like KNN, kernel ridge regression, and kernel SVMs, need labels and features to be stored in class. For example, <a href="https://www.shogun.ml/CKNN" target="_blank" rel="noopener">k-Nearest Neighbor</a>is one of them, KNN needs the features and labels to be stored in class, and then the stored features/labels are applied to new data. So it is convenient to divide the whole Machine family into non-parametric and parametric. The basic idea is to add a new interface called <a href="https://github.com/shogun-toolbox/shogun/pull/5055" target="_blank" rel="noopener"><code>NonParametricMachine</code></a>, then change all classes (such as KNN, GP) that require the training labels/features when being applied to new data to become subclasses of <code>NonParametricMachine</code>. The features and labels are stored in <code>NonParametricMachine</code> class, and when all the refactoring is done, those will be removed from the <code>Machine</code> class. Meanwhile, we also want to only set labels and feature when <code>train</code> is called. The typical non-parametric refactor looks like this:</p>
<ol>
<li>Remove all constructor parameter that involving in <code>labels</code>/<code>features</code>.<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">-KNN::KNN(int32_t k, const std::shared_ptr&lt;Distance&gt;&amp; d, const std::shared_ptr&lt;Labels&gt;&amp; trainlab, KNN_SOLVER knn_solver)</span></span><br><span class="line"><span class="addition">+KNN::KNN(int32_t k, const std::shared_ptr&lt;Distance&gt;&amp; d, KNN_SOLVER knn_solver)</span></span><br></pre></td></tr></table></figure></li>
<li>Remove default parameter NULL in <code>apply</code> and <code>train</code>.<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">-virtual std::shared_ptr&lt;MulticlassLabels&gt; train_machine(std::shared_ptr&lt;Features&gt; data=NULL);</span></span><br><span class="line"><span class="addition">+virtual std::shared_ptr&lt;MulticlassLabels&gt; train_machine(std::shared_ptr&lt;Features&gt; data);</span></span><br><span class="line"></span><br><span class="line">bool KNN::train_machine(std::shared_ptr&lt;Features&gt; data)&#123;</span><br><span class="line"><span class="deletion">-if (data)</span></span><br><span class="line"><span class="deletion">-&#123;</span></span><br><span class="line">	require(</span><br><span class="line">		    m_labels-&gt;get_num_labels() == data-&gt;get_num_vectors(),</span><br><span class="line">		    "Number of training vectors (&#123;&#125;) does not match number of labels "</span><br><span class="line">		    "(&#123;&#125;)",</span><br><span class="line">		    data-&gt;get_num_vectors(), m_labels-&gt;get_num_labels());</span><br><span class="line"><span class="deletion">-	distance-&gt;init(data, data);</span></span><br><span class="line"><span class="deletion">-&#125;</span></span><br><span class="line"><span class="addition">+m_features = data;</span></span><br><span class="line"><span class="addition">+distance-&gt;init(data, data);</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="Finding-all-class-needed-to-be-refactored-with-LibTooling"><a href="#Finding-all-class-needed-to-be-refactored-with-LibTooling" class="headerlink" title="Finding all class needed to be refactored with LibTooling"></a>Finding all class needed to be refactored with LibTooling</h2><p>We want to refactor all classes that are derived from <code>Machine</code>, the first step is to find all the lines of code where the class accesses <code>m_labels</code>.</p>
<p>Shogun has a large code base, so it is very hard to simply find all the lines of code that make <code>Machine</code> stateful with respect to m_labels. So my mentors suggested that I use <code>libtooling</code> to find all these instances. <code>LibTooling</code> is a really powerful tool, with a steep learning curve, used by the clang compiler to parse C++ code. After about one week, I have finally written this <a href="https://github.com/shogun-toolbox/shogun-libtooling/pull/1" target="_blank" rel="noopener">script</a>.</p>
<p>The main matcher is <code>memberExpr(member(hasName(&quot;m_labels&quot;))).bind(&quot;func&quot;)</code>, then we can get the AST of the <code>MemberExpr</code>. However, just printing all the lines of the <code>MemberExpr</code> is not readable. We should add more context, such as class name, method name. The LLVM AST has builtin functionality that helped me find the method and class names. We can use <code>getParents</code> to get <code>CXXMethodDecl</code>, and when we get <code>CXXMethodDecl</code>, it is easy to use <code>getParent</code> to get <code>CXXRecordDecl</code>. But the story does not end here, we only want to get every <code>CXXRecordDecl</code> that are derived from <code>Machine</code>. We have to restrict the base of the found <code>CXXRecordDecl</code> to be derived from <code>Machine</code>.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> record = method-&gt;getParent();</span><br><span class="line"><span class="keyword">bool</span> is_derived_from_machine = <span class="literal">false</span>;</span><br><span class="line">llvm::SmallPtrSet&lt;<span class="keyword">const</span> CXXRecordDecl *, <span class="number">4</span>&gt; Bases;</span><br><span class="line"><span class="keyword">auto</span> Collect = [&amp;Bases](<span class="keyword">const</span> CXXRecordDecl *Base) &#123;</span><br><span class="line">  Bases.insert(Base);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br><span class="line">record-&gt;forallBases(Collect);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> &amp;&amp;base : Bases)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (base-&gt;getNameAsString() == <span class="string">"Machine"</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    is_derived_from_machine = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="LabelEncoder"><a href="#LabelEncoder" class="headerlink" title="LabelEncoder"></a><code>LabelEncoder</code></h2><p>Currently, there are many <code>Labels</code> implemented in shogun, <code>BinaryLabels</code> and <code>MulticlassLabels</code> are  the<br>most commonly used. <code>BinaryLabels</code> contains two valid values <code>{-1, +1}</code>, and the valid values of <code>MulticlassLabels</code> is <code>{0...nr_classes-1}</code>(contiguous!), but the current implementation in shogun does not ensure the values in <code>Labels</code> are valid, so for some algorithms which require the valid values, the mapping from origin values to continuous values is needed Therefore, I designed the <code>LabelEncoder</code> base class and respective <code>BinaryLabelEncoder</code> and <code>MulticlassLabelsEncoder</code> derived classes to solve this problem.</p>
<p>The main idea is simple, maintain a mapping from origin values to continuous values, and create the respective inverse mapping. When <code>train</code> is called, the mapping and respective inverse mapping are stored. The mapping is used to transform the input labels to continuous values and the inverse operation is performed in <code>apply</code>.</p>
<p>The interfaces of <code>LabelEncoder</code> mainly refer to <a href="https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.LabelEncoder.html" target="_blank" rel="noopener">sklearn</a>, the basic usage looks like this:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> label_encoder = <span class="built_in">std</span>::make_shared&lt;BinaryLabelEncoder&gt;();</span><br><span class="line">SGVector&lt;<span class="keyword">int32_t</span>&gt; vec&#123;<span class="number">-100</span>, <span class="number">200</span>, <span class="number">-100</span>, <span class="number">200</span>, <span class="number">-100</span>&#125;;</span><br><span class="line"><span class="keyword">auto</span> origin_labels = <span class="built_in">std</span>::make_shared&lt;BinaryLabels&gt;(vec);</span><br><span class="line"><span class="keyword">auto</span> unique_vec = label_encoder-&gt;fit(origin_labels); <span class="comment">// unique_vec = &#123;-100, 200&#125;, the mapping is stored.</span></span><br><span class="line"><span class="keyword">auto</span> continuous_labels = labels_encoder-&gt;transform(origin_labels); <span class="comment">// continuous_labels = &#123;-1, 1 ,-1, 1, -1&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> origin_labels = labels_encoder-&gt;inverse_transform(continuous_labels); <span class="comment">// continuous_labels are transformed back to &#123;-100, 200, -100, 200, -100&#125;</span></span><br></pre></td></tr></table></figure>



    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/GSoC/" rel="tag"># GSoC</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/06/17/week2/" rel="prev" title="week2">
      <i class="fa fa-chevron-left"></i> week2
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/07/27/hello-world/" rel="next" title="Hello World">
      Hello World <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Refactoring-all-Machine-class"><span class="nav-number">1.</span> <span class="nav-text">Refactoring all Machine class</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Finding-all-class-needed-to-be-refactored-with-LibTooling"><span class="nav-number">2.</span> <span class="nav-text">Finding all class needed to be refactored with LibTooling</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LabelEncoder"><span class="nav-number">3.</span> <span class="nav-text">LabelEncoder</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">liuyuhui</p>
  <div class="site-description" itemprop="description">This is my blog</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">16</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">liuyuhui</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
